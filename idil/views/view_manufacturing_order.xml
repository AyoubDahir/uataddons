<?xml version="1.0" encoding="UTF-8"?>
<odoo>
    <!-- ===================================================== -->
    <!-- üè≠ Manufacturing Order | Form (Improved UI)            -->
    <!-- ===================================================== -->
  <record id="view_form_manufacturing_order" model="ir.ui.view">
        <field name="name">idil.manufacturing.order.form.dashboard</field>
        <field name="model">idil.manufacturing.order</field>
        <field name="arch" type="xml">
            <form string="üè≠ Manufacturing Order" class="o_form_full o_form_nosheet">

                <!-- HEADER -->
                <header>
                    <button name="action_confirm"
                            string="‚úÖ Confirm"
                            type="object"
                            class="btn-primary"/>

                    <button name="action_reset_to_draft"
                            string="üîÑ Reset To Draft"
                            type="object"
                            class="btn-info"/>

                    <button name="action_cancel"
                            string="‚õî Cancel"
                            type="object"
                            class="btn-danger"/>

                    <button name="action_open_extra_cost_wizard"
                            type="object"
                            string="‚ûï Extra Costs"
                            class="btn-primary"/>

                    <span class="ms-2 badge rounded-pill bg-light border text-muted px-3 py-2">
                        <i class="fa fa-flag me-1"/>
                        Status:
                        <field name="status" widget="badge" readonly="1" class="ms-1"/>
                    </span>
                </header>

                <sheet>

                    <!-- TITLE -->
                    <div class="oe_title">
                        <h1 class="mb-1">
                            <i class="fa fa-industry me-2 text-primary" role="img" aria-label="MO"/>
                            Manufacturing Order
                            <span class="ms-2 badge rounded-pill bg-light border text-muted px-3 py-2">
                                <i class="fa fa-hashtag me-1"/>
                                <field name="name" nolabel="1" readonly="1"/>
                            </span>
                        </h1>

                        <div class="text-muted">
                            <i class="fa fa-info-circle me-1"/>
                            Select Warehouse/Location, choose BOM, adjust quantities, then confirm to post inventory + accounting.
                        </div>
                    </div>

                    <!-- ‚úÖ 3 CARDS ROW -->
                    <div class="row g-3 mt-3">

                        <!-- Source & Planning -->
                        <div class="col-12 col-lg-4">
                            <div class="border rounded-4 p-3 shadow-sm bg-white h-100">
                                <div class="fw-bold mb-2 d-flex align-items-center gap-2">
                                    <i class="fa fa-map-marker text-muted"/>
                                    <span>Source &amp; Planning</span>
                                </div>

                                <div class="d-grid gap-2">

                                    <div class="d-flex align-items-center gap-3">
                                        <span class="fw-bold" style="min-width:150px;">
                                            <i class="fa fa-home me-1 text-muted"/> Warehouse
                                        </span>
                                        <div class="flex-grow-1">
                                            <field name="source_warehouse_id" nolabel="1"/>
                                        </div>
                                    </div>

                                    <div class="d-flex align-items-center gap-3">
                                        <span class="fw-bold" style="min-width:150px;">
                                            <i class="fa fa-location-arrow me-1 text-muted"/> Location
                                        </span>
                                        <div class="flex-grow-1">
                                            <field name="source_location_id" nolabel="1"/>
                                        </div>
                                    </div>

                                    <div class="d-flex align-items-center gap-3">
                                        <span class="fw-bold" style="min-width:150px;">
                                            <i class="fa fa-sitemap me-1 text-muted"/> Bill of Materials
                                        </span>
                                        <div class="flex-grow-1">
                                            <field name="bom_id" nolabel="1"/>
                                        </div>
                                    </div>

                                    <div class="d-flex align-items-center gap-3">
                                        <span class="fw-bold" style="min-width:150px;">
                                            <i class="fa fa-calendar me-1 text-muted"/> Start Date
                                        </span>
                                        <div class="flex-grow-1">
                                            <field name="scheduled_start_date" nolabel="1"/>
                                        </div>
                                    </div>

                                </div>

                                <div class="alert alert-info mt-3 mb-0">
                                    <i class="fa fa-lightbulb-o me-1"/>
                                    Stock validation will use the selected Warehouse/Location.
                                </div>
                            </div>
                        </div>

                        <!-- Product Output -->
                        <div class="col-12 col-lg-5">
                            <div class="border rounded-4 p-3 shadow-sm bg-white h-100">
                                <div class="fw-bold mb-2 d-flex align-items-center gap-2">
                                    <i class="fa fa-cube text-muted"/>
                                    <span>Product Output</span>
                                </div>

                                <div class="d-grid gap-2">

                                    <div class="d-flex align-items-center gap-3">
                                        <span class="fw-bold" style="min-width:170px;">
                                            <i class="fa fa-cubes me-1 text-muted"/> Product
                                        </span>
                                        <div class="flex-grow-1">
                                            <field name="product_id" nolabel="1" readonly="1"/>
                                        </div>
                                    </div>

                                    <div class="d-flex align-items-center gap-3">
                                        <span class="fw-bold" style="min-width:170px;">
                                            <i class="fa fa-sort-numeric-asc me-1 text-muted"/> Product Quantity
                                        </span>
                                        <div class="flex-grow-1">
                                            <field name="product_qty" nolabel="1"/>
                                        </div>
                                    </div>

                                    <hr class="my-2"/>

                                    <div class="d-flex align-items-center gap-3">
                                        <span class="fw-bold" style="min-width:170px;">
                                            <i class="fa fa-money me-1 text-muted"/> Product Cost Total
                                        </span>
                                        <div class="flex-grow-1 text-end">
                                            <field name="product_cost" nolabel="1" readonly="1"/>
                                        </div>
                                    </div>

                                    <div class="d-flex align-items-center gap-3">
                                        <span class="fw-bold" style="min-width:170px;">
                                            <i class="fa fa-plus-circle me-1 text-muted"/> Extra Cost Total
                                        </span>
                                        <div class="flex-grow-1 text-end">
                                            <field name="extra_cost_total" nolabel="1" readonly="1"/>
                                        </div>
                                    </div>

                                    <div class="d-flex align-items-center gap-3">
                                        <span class="fw-bold" style="min-width:170px;">
                                            <i class="fa fa-calculator me-1 text-muted"/> BOM Grand Total
                                        </span>
                                        <div class="flex-grow-1 text-end">
                                            <field name="bom_grand_total" nolabel="1" readonly="1"/>
                                        </div>
                                    </div>

                                </div>

                                <div class="mt-3">
                                    <span class="badge rounded-pill bg-light border text-muted px-3 py-2">
                                        <i class="fa fa-shield me-1"/>
                                        Product is taken from BOM (readonly).
                                    </span>
                                </div>
                            </div>
                        </div>

                        <!-- Finance -->
                        <div class="col-12 col-lg-3">
                            <div class="border rounded-4 p-3 shadow-sm bg-white h-100">
                                <div class="fw-bold mb-2 d-flex align-items-center gap-2">
                                    <i class="fa fa-line-chart text-muted"/>
                                    <span>Finance</span>
                                </div>

                                <div class="d-grid gap-2">

                                    <div class="d-flex align-items-center gap-3">
                                        <span class="fw-bold" style="min-width:140px;">
                                            <i class="fa fa-money me-1 text-muted"/> Currency
                                        </span>
                                        <div class="flex-grow-1">
                                            <field name="currency_id" nolabel="1"/>
                                        </div>
                                    </div>

                                    <div class="d-flex align-items-center gap-3">
                                        <span class="fw-bold" style="min-width:140px;">
                                            <i class="fa fa-exchange me-1 text-muted"/> Exchange Rate
                                        </span>
                                        <div class="flex-grow-1">
                                            <field name="rate" nolabel="1"/>
                                        </div>
                                    </div>

                                    <hr class="my-2"/>

                                    <div class="d-flex align-items-center gap-3">
                                        <span class="fw-bold" style="min-width:140px;">
                                            <i class="fa fa-user me-1 text-muted"/> Commission Employee
                                        </span>
                                        <div class="flex-grow-1">
                                            <field name="commission_employee_id" nolabel="1"/>
                                        </div>
                                    </div>

                                    <div class="d-flex align-items-center gap-3">
                                        <span class="fw-bold" style="min-width:140px;">
                                            <i class="fa fa-check-circle me-1 text-muted"/> Commission Amount
                                        </span>
                                        <div class="flex-grow-1 text-end">
                                            <field name="commission_amount" nolabel="1" readonly="1"/>
                                        </div>
                                    </div>

                                    <div class="d-flex align-items-center gap-3">
                                        <span class="fw-bold" style="min-width:140px;">
                                            <i class="fa fa-tag me-1 text-muted"/> TFG Qty
                                        </span>
                                        <div class="flex-grow-1 text-end">
                                            <field name="tfg_qty" nolabel="1" readonly="1"/>
                                        </div>
                                    </div>

                                </div>

                                <div class="text-muted small mt-2">
                                    <i class="fa fa-info-circle me-1"/>
                                    Rate uses currency rate on or before scheduled date.
                                </div>
                            </div>
                        </div>

                    </div>

                    <!-- ‚úÖ Journal Summary (display-only) -->
                    <div class="row g-3 mt-3">
                        <div class="col-12">
                            <div class="border rounded-4 p-3 shadow-sm bg-white">
                                <div class="fw-bold mb-2 d-flex align-items-center gap-2">
                                    <i class="fa fa-book text-muted"/>
                                    <span>Accounting Entry Summary</span>
                                </div>
                                <field name="journal_summary_html" nolabel="1" readonly="1"/>
                            </div>
                        </div>
                    </div>

                    <!-- ‚úÖ Notebook -->
                    <notebook class="mt-3">

                        <!-- Lines -->
                        <page string="üßæ Materials" name="page_lines">
                            <div class="border rounded-4 p-3 shadow-sm bg-white">

                                <div class="d-flex justify-content-between align-items-center flex-wrap gap-2 mb-2">
                                    <div class="fw-bold d-flex align-items-center gap-2">
                                        <i class="fa fa-list-ul text-muted"/>
                                        <span>Manufacturing Order Lines</span>
                                    </div>

                                    <span class="badge rounded-pill bg-light border text-muted px-3 py-2">
                                        <i class="fa fa-info-circle me-1"/>
                                        Confirm validates stock from selected Warehouse/Location.
                                    </span>
                                </div>

                                <div class="alert alert-warning mb-3" role="alert">
                                    <i class="fa fa-exclamation-triangle me-1"/>
                                    If stock shows ‚Äú0‚Äù but exists, verify movements were posted with the same Warehouse/Location.
                                </div>

                                <field name="manufacturing_order_line_ids"
                                       nolabel="1"
                                       widget="one2many_list"
                                       options="{'editable': 'bottom'}">
                                    <tree editable="bottom">
                                        <field name="item_id" string="üì¶ Item" options="{'no_create': True}"/>
                                        <field name="quantity_bom" string="üìå Planned" readonly="1" force_save="1" sum="Total"/>
                                        <field name="quantity" string="üßÆ Used" sum="Total"/>
                                        <field name="quantity_diff" string="‚öñÔ∏è Diff" readonly="1" sum="Total"/>
                                        <field name="cost_price" string="üíµ Unit Cost" sum="Total"/>
                                        <field name="row_total" string="üí∞ Row Total" readonly="1" sum="Total"/>
                                        <field name="cost_amount_sos" string="üí± Cost (SOS)" readonly="1" sum="Total"/>
                                    </tree>
                                </field>

                                <div class="text-muted mt-2">
                                    <i class="fa fa-info-circle me-1"/>
                                    You can edit ‚ÄúUsed‚Äù quantities. Planned quantities come from the BOM.
                                </div>

                            </div>
                        </page>

                        <!-- Extra Costs -->
                        <page string="‚ûï Extra Costs" name="page_extra_costs">
                            <div class="border rounded-4 p-3 shadow-sm bg-white">

                                <div class="d-flex justify-content-between align-items-center flex-wrap gap-2 mb-2">
                                    <div class="fw-bold d-flex align-items-center gap-2">
                                        <i class="fa fa-plus-circle text-muted"/>
                                        <span>Extra Costs</span>
                                    </div>

                                    <span class="badge rounded-pill bg-light border text-muted px-3 py-2">
                                        <i class="fa fa-calculator me-1"/>
                                        Total: <field name="extra_cost_total" nolabel="1" readonly="1"/>
                                    </span>
                                </div>

                                <field name="extra_cost_line_ids" nolabel="1">
                                    <tree editable="bottom">
                                        <field name="cost_type_id"/>
                                        <field name="employee_id"/>
                                        <field name="description"/>
                                        <field name="currency_id" readonly="1"/>
                                        <field name="expense_account_id" readonly="1"/>
                                        <field name="amount" sum="Total"/>
                                    </tree>
                                </field>

                                <div class="text-muted mt-2">
                                    <i class="fa fa-info-circle me-1"/>
                                    Extra costs can be added from the ‚Äú‚ûï Extra Costs‚Äù button (wizard) or directly here.
                                </div>

                            </div>
                        </page>

                        <!-- Chatter -->
                        <page string="üí¨ Chatter" name="page_chatter">
                            <field name="message_follower_ids" widget="mail_followers"/>
                            <field name="activity_ids" widget="mail_activity"/>
                            <field name="message_ids" widget="mail_thread"/>
                        </page>

                    </notebook>

                </sheet>
            </form>
        </field>
    </record>


    <!-- Manufacturing Order Tree View -->
    <record id="view_tree_manufacturing_order" model="ir.ui.view">
        <field name="name">idil.manufacturing.order.tree</field>
        <field name="model">idil.manufacturing.order</field>
        <field name="arch" type="xml">
            <tree string="Manufacturing Orders">
                <field name="name"/>
                <field name="bom_id"/>
                <field name="product_id"/>
                <field name="product_qty" sum="Total"/>
                <field name="product_cost" string="Product Cost Price" sum="Total"/>

                <field name="scheduled_start_date"/>
                <field name="status"/>
                <field name="commission_employee_id"/>
                <field name="commission_employee_id"/>
                <field name="commission_amount" sum="Total"/>
            </tree>
        </field>
    </record>
    <record id="view_kanban_manufacturing_order" model="ir.ui.view">
        <field name="name">idil.manufacturing.order.kanban</field>
        <field name="model">idil.manufacturing.order</field>
        <field name="arch" type="xml">
            <kanban>
                <field name="name"/>
                <field name="bom_id"/>
                <field name="product_id"/>
                <field name="product_qty"/>
                <field name="status"/>
                <field name="scheduled_start_date"/>
                <templates>
                    <t t-name="kanban-box">
                        <div class="oe_kanban_global_click">
                            <strong>
                                <field name="name"/>
                            </strong>
                            <div>BOM: <field name="bom_id"/></div>
                            <div>Product: <field name="product_id"/></div>
                            <div>Qty: <field name="product_qty"/></div>
                            <div>Date: <field name="scheduled_start_date"/></div>
                            <div>Status: <field name="status"/></div>
                        </div>
                    </t>
                </templates>
            </kanban>
        </field>
    </record>

    <record id="view_idil_mo_add_extra_cost_wizard_form" model="ir.ui.view">
    <field name="name">idil.mo.add.extra.cost.wizard.form</field>
    <field name="model">idil.mo.add.extra.cost.wizard</field>
    <field name="arch" type="xml">
        <form string="‚ûï Add Extra Costs" class="o_form_full">
            <sheet>

                <!-- Header area -->
                <div class="border rounded-4 p-3 shadow-sm bg-white mb-3">
                    <div class="d-flex justify-content-between align-items-center flex-wrap gap-2">
                        <div>
                            <div class="fw-bold" style="font-size:16px;">
                                <i class="fa fa-plus-circle text-primary me-1"/>
                                Add Extra Costs to Manufacturing Order
                            </div>
                            <div class="text-muted small">
                                Add labor/vendor/service costs to improve product costing accuracy.
                            </div>
                        </div>

                        <span class="badge rounded-pill bg-light border text-muted px-3 py-2">
                            <i class="fa fa-hashtag me-1"/>
                            <field name="manufacturing_order_id" nolabel="1" readonly="1"/>
                        </span>
                    </div>
                </div>

                <!-- Lines -->
                <div class="border rounded-4 p-3 shadow-sm bg-white">
                    <div class="fw-bold mb-2 d-flex align-items-center gap-2">
                        <i class="fa fa-list text-muted"/>
                        <span>Extra Cost Lines</span>
                    </div>

                    <field name="line_ids" nolabel="1" options="{'editable':'bottom'}">
                        <tree editable="bottom">
                            <field name="cost_type_id" required="1"/>
                            <field name="employee_id"/>
                             
                            <field name="description"/>
                            <field name="currency_id" readonly="1"/>
                            <field name="expense_account_id" readonly="1"/>
                            <field name="amount" sum="Total"/>
                        </tree>
                    </field>

                    <div class="text-muted mt-2 small">
                        <i class="fa fa-info-circle me-1"/>
                        Tip: Choose either Employee OR Partner/Vendor depending on the cost type.
                    </div>
                </div>

            </sheet>

            <footer>
                <button string="Apply" type="object" name="action_apply" class="btn-primary"/>
                <button string="Cancel" class="btn-secondary" special="cancel"/>
            </footer>
        </form>
    </field>
</record>


    <!-- Action to Open Manufacturing Order View -->
    <record id="action_manufacturing_orders" model="ir.actions.act_window">
        <field name="name">Manufacturing Orders</field>
        <field name="res_model">idil.manufacturing.order</field>
        <field name="view_mode">kanban,tree,form</field>
        <field name="view_id" ref="view_tree_manufacturing_order"/>
        <field name="context">{'group_by': ['scheduled_start_date:month', 'scheduled_start_date:day']}</field>
        <field name="domain">[('status','!=','cancelled')]</field>

    </record>


</odoo>
